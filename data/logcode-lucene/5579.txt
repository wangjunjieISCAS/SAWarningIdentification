GitDiffStart: 0cb726bba30a4d4d3699bce26345ed7aff7d2f15 | Fri Aug 22 19:14:11 2014 +0000
diff --git a/build.xml b/build.xml
index 5b51805..96e94da 100644
--- a/build.xml
+++ b/build.xml
@@ -24,6 +24,9 @@
   <property file="${basedir}/build.properties"/>
   <property file="lucene/build.properties"/><!-- hack for Lucene users, clones Lucene's common-build.xml -->
 
+  <!-- include version number from property file (includes "version.*" properties) -->
+  <loadproperties srcFile="lucene/version.properties"/>
+
   <target name="-projecthelp">
     <java fork="false" classname="org.apache.tools.ant.Main" taskname="-">
       <arg value="-projecthelp"/>
@@ -144,7 +147,6 @@
     </subant>
   </target>
 
-  <property name="version" value="5.0.0-SNAPSHOT"/>
   <property name="maven-build-dir" value="maven-build"/>
   <property name="maven-version" value="2.2.1"/>
 
@@ -287,11 +289,19 @@
     </condition>
     <!-- Define ${idea.jdk} if it's not yet defined - otherwise literal "${idea.jdk}" is substituted -->
     <property name="idea.jdk" value=""/>
-    <copy todir=".">
+    <!-- delete those files first, so they are regenerated by the filtering below
+      (add more files with dynamic properties like versions here): -->
+    <delete dir=".idea" includes="misc.xml workspace.xml"/>
+    <!-- Copy files with filtering: -->
+    <copy todir="." overwrite="false" encoding="UTF-8">
       <fileset dir="dev-tools/idea"/>
       <filterset begintoken="subst.=&quot;" endtoken="&quot;">
         <filter token="idea.jdk" value="${idea.jdk}"/>
       </filterset>
+      <filterset>
+        <filter token="version" value="${version}"/>
+        <filter token="version.base" value="${version.base}"/>
+      </filterset>
     </copy>
     <antcall target="-post-idea-instructions"/>
   </target>
@@ -359,7 +369,7 @@ File | Project Structure | Platform Settings | SDKs):
   <property name="python32.exe" value="python3.2" />
   <property name="fakeRelease" location="lucene/build/fakeRelease"/>
   <property name="fakeReleaseTmp" location="lucene/build/fakeReleaseTmp"/>
-  <property name="fakeReleaseVersion" value="5.0.0"/> <!-- *not* -SNAPSHOT, the real version -->
+  <property name="fakeReleaseVersion" value="${version.base}"/>
   <property name="smokeTestRelease.testArgs" value=""/>
 
   <target name="-load-env">
diff --git a/dev-tools/idea/.idea/workspace.xml b/dev-tools/idea/.idea/workspace.xml
index c0a856d..b7e529d 100644
--- a/dev-tools/idea/.idea/workspace.xml
+++ b/dev-tools/idea/.idea/workspace.xml
@@ -8,7 +8,7 @@
       <module name="lucene-core-tests" />
       <option name="TEST_OBJECT" value="package" />
       <option name="WORKING_DIRECTORY" value="file://$PROJECT_DIR$/idea-build/lucene/core" />
-      <option name="VM_PARAMETERS" value="-Xmx256m -ea -Dversion.base=5.0.0 -DtempDir=temp" />
+      <option name="VM_PARAMETERS" value="-Xmx256m -ea -DtempDir=temp" />
       <option name="TEST_SEARCH_SCOPE"><value defaultName="singleModule" /></option>
     </configuration>
     <configuration default="false" name="Module analyzers-common" type="JUnit" factoryName="JUnit">
@@ -183,28 +183,28 @@
       <module name="solr-core-tests" />
       <option name="TEST_OBJECT" value="package" />
       <option name="WORKING_DIRECTORY" value="file://$PROJECT_DIR$/idea-build/solr/solr-core" />
-      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=5.0.0 -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
+      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=@version.base@ -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
       <option name="TEST_SEARCH_SCOPE"><value defaultName="singleModule" /></option>
     </configuration>
     <configuration default="false" name="Solrj" type="JUnit" factoryName="JUnit">
       <module name="solrj-tests" />
       <option name="TEST_OBJECT" value="package" />
       <option name="WORKING_DIRECTORY" value="file://$PROJECT_DIR$/idea-build/solr/solr-solrj" />
-      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=5.0.0 -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
+      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=@version.base@ -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
       <option name="TEST_SEARCH_SCOPE"><value defaultName="singleModule" /></option>
     </configuration>
     <configuration default="false" name="Solr analysis-extras contrib" type="JUnit" factoryName="JUnit">
       <module name="analysis-extras" />
       <option name="TEST_OBJECT" value="package" />
       <option name="WORKING_DIRECTORY" value="file://$PROJECT_DIR$/idea-build/solr/contrib/solr-analysis-extras" />
-      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=5.0.0 -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
+      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=@version.base@ -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
       <option name="TEST_SEARCH_SCOPE"><value defaultName="singleModule" /></option>
     </configuration>
     <configuration default="false" name="Solr clustering contrib" type="JUnit" factoryName="JUnit">
       <module name="clustering" />
       <option name="TEST_OBJECT" value="package" />
       <option name="WORKING_DIRECTORY" value="file://$PROJECT_DIR$/idea-build/solr/contrib/solr-clustering" />
-      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=5.0.0 -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
+      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=@version.base@ -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
       <option name="TEST_SEARCH_SCOPE"><value defaultName="singleModule" /></option>
     </configuration>
     <configuration default="false" name="Solr dataimporthandler contrib" type="JUnit" factoryName="JUnit">
@@ -260,7 +260,7 @@
       <module name="uima" />
       <option name="TEST_OBJECT" value="package" />
       <option name="WORKING_DIRECTORY" value="file://$PROJECT_DIR$/idea-build/solr/contrib/solr-uima" />
-      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=5.0.0 -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
+      <option name="VM_PARAMETERS" value="-ea -Dtests.luceneMatchVersion=@version.base@ -DtempDir=temp -Djetty.testMode=1 -Djetty.insecurerandom=1 -Dsolr.directoryFactory=org.apache.solr.core.MockDirectoryFactory" />
       <option name="TEST_SEARCH_SCOPE"><value defaultName="singleModule" /></option>
     </configuration>
     <configuration default="false" name="Solr velocity contrib" type="JUnit" factoryName="JUnit">
diff --git a/lucene/common-build.xml b/lucene/common-build.xml
index b9feb20..3bfa9e7 100644
--- a/lucene/common-build.xml
+++ b/lucene/common-build.xml
@@ -26,13 +26,6 @@
     for standalone use.
   </description>
 
-  <!-- !!! RELEASE MANAGER: Change version numbers only here: !!! -->
-  
-  <!-- The base version of the next release (including bugfix number, e.g., x.y.z+): -->
-  <property name="version.base" value="5.0.0"/>
-  
-  <!-- !!! RELEASE MANAGER: Don't change anything after this line! !!! -->
-
   <dirname file="${ant.file.common}" property="common.dir"/>
   <property name="dev-tools.dir" location="${common.dir}/../dev-tools"/>
   <property name="prettify.dir" location="${common.dir}/tools/prettify"/>
@@ -57,16 +50,15 @@
   <property name="Name" value="Lucene"/>
   <property name="name" value="${ant.project.name}"/>
   
-  <!--TODO: remove once Jenkins jobs are updated:--><property name="dev.version.suffix" value="SNAPSHOT"/>
-
-  <!-- Suffix of the version, by default SNAPSHOT: -->
-  <property name="version.suffix" value="${dev.version.suffix}"/>
-  <property name="version" value="${version.base}-${version.suffix}"/>
+  <!-- include version number from property file (includes "version.*" properties) -->
+  <loadproperties srcFile="${common.dir}/version.properties"/>
   
-  <!-- must be in format x.y with only digits, so we use version.base: -->
-  <property name="spec.version" value="${version.base}"/>
+  <fail message="'version.base' property must be 'x.y.z' (major, minor, bugfix) or 'x.y.z.1/2' (+ prerelease) and numeric only: ${version.base}">
+    <condition>
+      <not><matches pattern="^\d+\.\d+\.\d+(|\.1|\.2)$" casesensitive="true" string="${version.base}"/></not>
+    </condition>
+  </fail>
 
-  
   <fail message="If you pass -Dversion=... to set a release version, it must match &quot;${version.base}&quot;, optionally followed by a suffix (e.g., &quot;-SNAPSHOT&quot;).">
     <condition>
       <not><matches pattern="^\Q${version.base}\E(|\-.*)$" casesensitive="true" string="${version}"/></not>
diff --git a/lucene/version.properties b/lucene/version.properties
new file mode 100644
index 0000000..21538dc
--- /dev/null
+++ b/lucene/version.properties
@@ -0,0 +1,10 @@
+# This file contains some version properties as used by various build files.
+
+# RELEAE MANAGER must change this file after creating a release and
+# enter new base version (format "x.y.z", no prefix/appendix): 
+version.base=5.0.0
+
+# Other version property defaults, don't change:
+version.suffix=SNAPSHOT
+version=${version.base}-${version.suffix}
+spec.version=${version.base}

